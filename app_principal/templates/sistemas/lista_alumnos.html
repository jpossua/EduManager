{% extends 'sistemas/base.html' %}
<!--
=====================================================================
LISTA_ALUMNOS.HTML - Gestión de Alumnos
=====================================================================
Muestra una tabla con todos los alumnos del profesor logueado.
Incluye modales de Bootstrap para crear y eliminar alumnos.

DATOS DISPONIBLES (desde views.py → lista_alumnos()):
alumnos → Lista de alumnos (filtrados por materias del profesor)
alumnos.count → Número total de alumnos
form → AlumnoForm vacío para el modal de crear
materias → Lista de materias del profesor

MODALES DE BOOTSTRAP:
Los modales son ventanas superpuestas que aparecen sin cambiar de página.
Funcionan con atributos data-bs-*:
- data-bs-toggle="modal" → Activa el modal
- data-bs-target="#id" → ID del modal a abrir
- data-bs-dismiss="modal" → Cierra el modal

IMPORTANTE: Los modales de eliminación se generan DENTRO del bucle 'for'
para que cada alumno tenga su propio modal con su propio ID.
El ID dinámico se forma con: #eliminarAlumnoModal + alumno.id
===================================================================== 
-->


{% block title %}Alumnos - EduManage{% endblock %}

{% block content %}

<!-- Encabezado con título y botón para abrir el modal de crear alumno -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-dark">Gestión de Alumnos</h2>
        <p class="text-muted mb-0">{{ alumnos.count }} alumnos registrados</p>
    </div>
    <div class="d-flex gap-2">
        <!-- data-bs-toggle + data-bs-target: Abre el modal de crear alumno -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#crearAlumnoModal"><i
                class="bi bi-plus-lg"></i> Añadir Alumno</button>
    </div>
</div>

<!-- ================================================
     TABLA DE ALUMNOS
     ================================================
     table-hover: Resalta la fila al pasar el ratón
     table-responsive: Añade scroll horizontal en pantallas pequeñas
-->
<div class="card">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">ID</th>
                    <th>Alumno</th>
                    <th>Correo</th>
                    <th>Materias</th>
                    <th class="text-end pe-4">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- 'for': Recorre cada alumno de la lista -->
                {% for alumno in alumnos %}
                <tr>
                    <!-- forloop.counter: Número de iteración (1, 2, 3...) -->
                    <td class="ps-4 text-muted fw-bold">#{{ forloop.counter }}</td>
                    <td>
                        <div class="fw-bold text-dark">{{ alumno.nombre }}</div>
                    </td>
                    <td class="text-muted">{{ alumno.correo }}</td>
                    <td>
                        <!-- alumno.materias.all: Accede a la relación M2M para listar materias -->
                        {% for materia in alumno.materias.all %}
                        <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">{{materia.nombre}}</span>
                        {% empty %}
                        <span class="text-muted small">Sin materias</span>
                        {% endfor %}
                    </td>
                    <td class="text-end pe-4">
                        <!-- Botón editar: Redirige a la página de edición del alumno -->
                        <a href="{% url 'editar_alumno' alumno.id %}" class="btn btn-sm btn-link text-muted p-0 me-2"><i
                                class="bi bi-pencil-square fs-5"></i></a>
                        <!-- Botón eliminar: Abre un modal de confirmación específico -->
                        <button class="btn btn-sm btn-link text-danger p-0" data-bs-toggle="modal"
                            data-bs-target="#eliminarAlumnoModal{{ alumno.id }}"><i
                                class="bi bi-trash fs-5"></i></button>
                    </td>
                </tr>

                <!-- ================================================
                     MODAL ELIMINAR ALUMNO (uno por cada alumno)
                     ================================================
                     Cada alumno tiene su propio modal con un ID único:
                     eliminarAlumnoModal{{ alumno.id }}
                     
                     Al confirmar, se envía un POST con csrf_token
                     a la URL 'eliminar_alumno' con el ID del alumno.
                -->
                <div class="modal fade" id="eliminarAlumnoModal{{ alumno.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header border-0">
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center pb-5">
                                <div class="text-danger mb-3"><i class="bi bi-exclamation-circle display-1"></i></div>
                                <h4 class="fw-bold">¿Eliminar Alumno?</h4>
                                <p class="text-muted">Estás a punto de eliminar a <span
                                        class="fw-bold">{{alumno.nombre}}</span>. Esta acción es irreversible.</p>
                                <form method="post" action="{% url 'eliminar_alumno' alumno.id %}">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-light px-4"
                                        data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-danger px-4 fw-bold">Sí, Eliminar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                {% empty %}
                <!-- Se muestra cuando no hay alumnos -->
                <tr>
                    <td colspan="5" class="text-center py-5">No hay alumnos asignados a tus materias.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================================================
     MODAL CREAR ALUMNO
     ================================================
     Modal independiente (fuera del bucle 'for') porque solo hay uno.
     El formulario se envía a la URL 'crear_alumno' con POST.
     
     {{ form.nombre }}: Renderiza el <input> del campo nombre
     {{ form.correo }}: Renderiza el <input> del campo correo
     {{ form.materias }}: Renderiza los checkboxes de materias
     
     Estos campos vienen del AlumnoForm definido en forms.py
     y ya incluyen las clases Bootstrap.
-->
<div class="modal fade" id="crearAlumnoModal" tabindex="-1" aria-labelledby="crearAlumnoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="crearAlumnoModalLabel">Añadir Nuevo Alumno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'crear_alumno' %}" id="formCrearAlumno">
                <div class="modal-body">
                    {% csrf_token %}
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <small>{{ form.errors }}</small>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="{{ form.nombre.id_for_label }}"
                            class="form-label text-muted small fw-bold text-uppercase">Nombre Completo</label>
                        {{ form.nombre }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.correo.id_for_label }}"
                            class="form-label text-muted small fw-bold text-uppercase">Correo Electrónico</label>
                        {{ form.correo }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold text-uppercase">Asignar Materias <span
                                class="text-danger">*</span></label>
                        <!-- Contenedor scrollable para los checkboxes de materias -->
                        <div class="card p-2 bg-light border-0" style="max-height: 150px; overflow-y: auto;"
                            id="materiasContainerCrear">
                            {{ form.materias }}
                        </div>
                        <div class="form-text small">Selecciona al menos una materia.</div>
                        <div class="text-danger small mt-1 d-none" id="errorMateriasCrear">¡Error, este campo es
                            obligatorio!</div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary fw-bold">Guardar Alumno</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================================================
     VALIDACIÓN JAVASCRIPT - Materias obligatorias
     ================================================
     Valida del lado del cliente que al menos una materia
     esté seleccionada antes de enviar el formulario.
-->
<script>
    document.getElementById('formCrearAlumno').addEventListener('submit', function (e) {
        var checks = this.querySelectorAll('input[name="materias"]:checked');
        var errorDiv = document.getElementById('errorMateriasCrear');
        var container = document.getElementById('materiasContainerCrear');
        if (checks.length === 0) {
            e.preventDefault(); // Detiene el envío
            errorDiv.classList.remove('d-none'); // Muestra error
            container.classList.add('border', 'border-danger'); // Borde rojo
        } else {
            errorDiv.classList.add('d-none'); // Oculta error
            container.classList.remove('border', 'border-danger'); // Quita borde rojo
        }
    });
</script>
{% endblock %}